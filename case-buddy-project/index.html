<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Buddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Phosphor Icons for clean UI -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        main { background-color: #ffffff; }
        
        /* Gradient Utilities */
        .gradient-text {
            background-image: linear-gradient(to right, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .gradient-bg { background-image: linear-gradient(to right, #3b82f6, #10b981); }
        
        /* UI Components */
        .filter-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db;
        }
        .filter-btn.active {
            background-image: linear-gradient(to right, #3b82f6, #10b981);
            color: white;
            border-color: transparent;
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
        }
        .case-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #e2e8f0;
        }
        .case-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            border-color: #3b82f6; 
        }
        
        /* Modals */
        #company-modal, #warning-modal, #feedback-modal, #login-modal, #insight-modal { backdrop-filter: blur(4px); }
        
        /* PDF Viewer */
        #pdf-render-container { position: relative; overflow-y: auto; }
        #pdf-canvas { display: block; margin: 0 auto; transition: opacity 0.3s ease-in-out; }
        #pdf-controls {
            position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6); border-radius: 0.5rem; padding: 0.5rem 1rem;
            display: flex; align-items: center; gap: 1rem; z-index: 10;
        }
        
        /* Ratings */
        .star-rating { direction: rtl; display: inline-flex; }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label { cursor: pointer; color: #d1d5db; font-size: 2.5rem; transition: color 0.2s; }
        .star-rating label:hover, .star-rating label:hover ~ label, .star-rating input[type="radio"]:checked ~ label { color: #f59e0b; }
        #overall-rating-display .star { color: #d1d5db; font-size: 2.5rem; }
        #overall-rating-display .star.filled { color: #f59e0b; }
        
        /* Misc */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dashboard-animate-fade-in { animation: fadeIn 0.5s; } 
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }

        /* Login/Profile Styles */
        .mascot-option { transition: all 0.3s ease; border: 2px solid transparent; position: relative; overflow: hidden; }
        .mascot-option:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .mascot-option.selected { border-color: var(--mascot-color); background-color: white; transform: scale(1.05); box-shadow: 0 0 0 4px var(--mascot-shadow); }
        
        .user-pill-container { position: relative; }
        .user-pill { transition: all 0.2s ease; }
        .user-pill:hover { background-color: #f8fafc; border-color: #cbd5e1; }
        
        .profile-hover-card {
            opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease-in-out;
        }
        .user-pill-container:hover .profile-hover-card { opacity: 1; visibility: visible; transform: translateY(0); }

        /* Neopolitan Profile Theme */
        .neo-card { border: 1px solid #f1f5f9; background: white; border-radius: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .neo-card:hover { transform: translateY(-2px); }
        .neo-stat-value { font-family: 'Inter', sans-serif; font-weight: 800; }
        .bg-neo-pink { background-color: #fff1f2; color: #be123c; }
        .bg-neo-cream { background-color: #fffbeb; color: #b45309; }
        .bg-neo-dark { background-color: #1e293b; color: #f8fafc; }

        /* Voice Recorder Animations */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-active {
            animation: pulse-red 1.5s infinite;
            background-color: #fee2e2 !important;
            color: #ef4444 !important;
            border-color: #ef4444 !important;
        }
        .ai-content h3 { font-weight: 700; color: #334155; margin-top: 1rem; margin-bottom: 0.5rem; }
        .ai-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .ai-content li { margin-bottom: 0.25rem; }
        .ai-content strong { color: #0f172a; }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EJTFDTP163"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-EJTFDTP163');
    </script>
</head>
<body class="bg-slate-100 text-slate-800">

    <header class="bg-white sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo Section -->
                <div class="flex items-center cursor-pointer" id="home-button">
                    <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="url(#grad1)">
                        <defs>
                           <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                             <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                             <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
                           </linearGradient>
                        </defs>
                        <path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                    </svg>
                    <span class="ml-3 text-2xl font-bold gradient-text">Case Buddy</span>
                </div>

                <!-- Dynamic Nav Container -->
                <div class="flex items-center gap-4" id="nav-actions-container">
                    <!-- Injected by JS -->
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 mt-4 rounded-lg shadow-md bg-white">

        <!-- WELCOME / FILTER VIEW -->
        <div id="welcome-view">
            <div class="text-center my-12">
                <h1 class="text-5xl md:text-6xl font-extrabold gradient-text">Ready to crack a case?</h1>
                <p class="text-slate-500 text-lg mt-4">Let's find the perfect one for you.</p>
            </div>

            <div class="max-w-4xl mx-auto p-8 space-y-10">
                <!-- Case Type Filter -->
                <div class="grid md:grid-cols-3 items-start gap-4">
                    <h2 class="text-lg font-semibold text-slate-700 mt-2">What's the case style?</h2>
                    <div id="type-filters" class="md:col-span-2 flex flex-wrap gap-3"></div>
                </div>

                <!-- Difficulty Filter -->
                <div class="grid md:grid-cols-3 items-start gap-4">
                    <h2 class="text-lg font-semibold text-slate-700 mt-2">Choose your challenge.</h2>
                    <div id="difficulty-filters" class="md:col-span-2 flex flex-wrap gap-3"></div>
                </div>

                <!-- Company Filter -->
                <div class="grid md:grid-cols-3 items-start gap-4">
                    <h2 class="text-lg font-semibold text-slate-700 mt-2">Any firm in mind?</h2>
                    <div class="md:col-span-2">
                        <button id="open-company-modal-btn" class="w-full text-left p-3 border rounded-lg hover:border-blue-500 transition">
                            Select Companies
                        </button>
                        <p id="company-count" class="text-sm text-slate-500 mt-2 h-4"></p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center pt-8">
                    <button id="search-cases-btn" class="gradient-bg text-white px-10 py-3 rounded-lg font-semibold hover:opacity-90 transition transform hover:scale-105 shadow-lg">
                        Find Your Case
                    </button>
                    <p class="mt-6 text-slate-500">Or, if you're feeling adventurous...</p>
                    <button id="view-all-btn" class="mt-2 font-semibold text-transparent gradient-text hover:opacity-80">
                        View the Entire Case Library
                    </button>
                </div>
            </div>
        </div>
        
        <!-- CASE LIBRARY VIEW -->
        <div id="case-library-view" class="hidden">
            <div class="flex justify-between items-center mb-8">
                 <h1 class="text-4xl font-bold gradient-text">Case Library</h1>
                 <button id="back-to-filters-btn" class="font-semibold text-slate-600 hover:text-slate-900 transition">
                     &larr; Back to Filters
                 </button>
            </div>
            <div id="case-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- DETAILED CASE VIEW -->
        <div id="detailed-case-view" class="hidden">
             <div class="flex items-center space-x-4 mb-6">
                <span id="case-detail-type" class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full"></span>
                <span id="case-detail-company" class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full"></span>
                <span id="case-detail-difficulty" class="bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full"></span>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4 gradient-text">Problem Statement</h2>
                    <p id="case-detail-problem" class="text-slate-600 leading-relaxed"></p>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                    <h2 class="text-2xl font-bold mb-4 gradient-text">Instructions for Solver</h2>
                    <div class="text-slate-600 space-y-3 flex-grow">
                        <p>1. Read the problem statement carefully.</p>
                        <p>2. Take a moment to structure your thoughts.</p>
                        <p>3. When ready, click "Do this case" to begin the interactive session with your buddy (interviewer).</p>
                        <p>4. You will then guide the case, asking clarifying questions and presenting your framework.</p>
                    </div>
                    <div class="mt-6 text-right">
                         <button id="back-to-library-btn" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-lg font-semibold hover:bg-slate-300 transition mr-2">Back to Library</button>
                        <button id="do-case-btn" class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">Do this case</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- IN-PROGRESS VIEW -->
        <div id="in-progress-view" class="hidden">
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left: PDF Viewer -->
                <div class="bg-white p-6 rounded-lg shadow-md h-[85vh] flex flex-col lg:col-span-2">
                    <h2 id="casebook-title" class="text-2xl font-bold mb-4 shrink-0 gradient-text">Interviewer's Guide</h2>
                    <div id="pdf-render-container" class="flex-grow rounded-lg overflow-hidden border bg-slate-100 p-2">
                        <canvas id="pdf-canvas"></canvas>
                        <div id="pdf-controls">
                            <button id="pdf-prev" class="text-white hover:text-blue-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <span class="text-white font-mono text-sm">
                                <span id="page-num"></span> / <span id="page-count"></span>
                            </span>
                            <button id="pdf-next" class="text-white hover:text-blue-300 disabled:opacity-50 disabled:cursor-not-allowed">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                            <button id="pdf-fullscreen" class="text-white hover:text-blue-300 ml-4">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" /></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right: Interviewer Controls + Voice AI -->
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col h-[85vh]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-800">Control Panel</h2>
                        <div class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                            <i class="ph ph-lightning-fill"></i> AI Active
                        </div>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto pr-2 space-y-6 custom-scrollbar">
                        <!-- Static Instructions -->
                        <div class="bg-blue-50 p-4 rounded-lg text-sm text-slate-600 border border-blue-100">
                            <h3 class="font-bold text-blue-800 mb-2 flex items-center gap-2"><i class="ph ph-info"></i> Guide</h3>
                            <ul class="list-disc pl-4 space-y-1">
                                <li>Use the PDF on the left to guide the interviewee.</li>
                                <li>Provide hints only when necessary.</li>
                                <li>Use the recorder below for real-time AI analysis.</li>
                            </ul>
                        </div>

                        <!-- Voice Recorder -->
                        <div class="space-y-3">
                            <label class="block text-sm font-semibold text-slate-700 flex justify-between">
                                Verbal Feedback
                                <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">Auto-transcribing</span>
                            </label>
                            
                            <div class="relative">
                                <textarea id="transcript-box" class="w-full h-32 p-4 text-sm text-slate-600 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none bg-slate-50" 
                                    placeholder="Tap mic & speak feedback..."></textarea>
                                
                                <!-- Floating Mic Button -->
                                <button id="record-btn" class="absolute bottom-3 right-3 w-10 h-10 rounded-full bg-white shadow-md border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-500 transition-all group flex items-center justify-center z-10">
                                    <i class="ph ph-microphone text-lg"></i>
                                </button>
                            </div>
                            
                            <div class="flex justify-between items-center h-4">
                                <p id="status-text" class="text-xs text-slate-400 italic">Ready</p>
                                <button id="clear-btn" class="text-xs text-slate-400 hover:text-red-500 underline hidden">Clear</button>
                            </div>
                        </div>

                        <!-- Action Area -->
                        <button id="analyze-btn" class="w-full bg-gradient-to-r from-blue-600 to-emerald-500 text-white font-bold py-3 rounded-xl shadow-md hover:opacity-90 transition transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <span id="btn-text">Generate AI Insights</span>
                            <i class="ph ph-sparkle"></i>
                        </button>

                        <!-- AI Results -->
                        <div id="ai-result-container" class="hidden dashboard-animate-fade-in pb-4">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="h-px bg-slate-200 flex-grow"></div>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Analysis</span>
                                <div class="h-px bg-slate-200 flex-grow"></div>
                            </div>
                            <div id="ai-output" class="text-xs text-slate-700 bg-white p-4 rounded-xl border border-slate-200 shadow-sm ai-content leading-relaxed"></div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t text-right bg-white">
                        <button id="end-case-btn" class="bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition w-full">End Case & Rate</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABOUT VIEW -->
        <div id="about-view" class="hidden">
            <div class="max-w-4xl mx-auto py-12">
                <h1 class="text-5xl font-extrabold gradient-text text-center">About Case Buddy</h1>
                <p class="text-slate-600 text-lg mt-6 text-center">Your personal partner for mastering the case interview.</p>
                <div class="mt-10 text-slate-700 leading-relaxed space-y-4">
                    <p><strong>Case Buddy</strong> was designed to streamline the case interview preparation process for aspiring consultants. We believe that practice is key, but effective practice requires the right tools. Our platform provides a comprehensive library of real-world case studies from top consulting firms, allowing you to hone your skills in a structured and realistic environment.</p>
                    <p>Whether you're practicing solo or with a partner, Case Buddy provides the resources you need. The "Interviewer" and "Interviewee" views simulate a real interview, with a complete interviewer's guide available to help provide constructive feedback.</p>
                    <p>Our goal is to make high-quality case prep accessible to everyone. Use our filtering tools to find cases that match your target firms and desired difficulty, track your progress on the dashboard, and walk into your interviews with confidence.</p>
                </div>
                <div class="mt-10 text-center">
                    <h3 class="text-2xl font-bold text-slate-800">Get in Touch</h3>
                    <p class="text-slate-600 mt-2">
                        Have questions, feedback, or want to contribute? Email us at: 
                        <a href="mailto:casebuddy.du@gmail.com" class="font-semibold text-blue-600 hover:underline">casebuddy.du@gmail.com</a>
                    </p>
                </div>
                <div class="mt-12">
                    <h2 class="text-3xl font-bold text-slate-800 text-center">Meet the Founders</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 mt-8 text-center">
                        <div class="p-4"><p class="font-semibold text-lg text-slate-700">Nitya Mall</p></div>
                        <div class="p-4"><p class="font-semibold text-lg text-slate-700">Niepun Singhal</p></div>
                        <div class="p-4"><p class="font-semibold text-lg text-slate-700">Pratik Agarwal</p></div>
                        <div class="p-4"><p class="font-semibold text-lg text-slate-700">Saksham Didwania</p></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="hidden">
            <div class="max-w-7xl mx-auto">
                <header class="mb-4">
                    <h1 class="text-3xl font-bold text-slate-800">My Case Prep Dashboard</h1>
                    <p class="text-slate-500 mt-1">Your comprehensive performance and progress tracker.</p>
                </header>
                <div class="flex justify-between items-center mb-4">
                    <div id="dashboard-date-picker" class="flex gap-2 items-center"></div>
                    <div class="flex gap-4 items-center text-xs text-gray-600">
                        <span class="font-semibold">Score Legend:</span>
                        <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-red-500 mr-1.5"></div>Poor (&lt;70)</div>
                        <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-amber-500 mr-1.5"></div>Medium (70-84)</div>
                        <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-green-500 mr-1.5"></div>Good (85+)</div>
                    </div>
                </div>
                <div id="dashboard-active-filters"></div>
                <main class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow text-center">
                                <h2 class="text-lg font-semibold text-gray-600">Case Score™</h2>
                                <div id="dashboard-score-card" class="font-bold my-2"></div>
                                <p class="text-gray-500 text-sm">Avg. score for selected filters.</p>
                            </div>
                            <div id="dashboard-metric-breakdown"></div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div id="dashboard-type-chart"></div>
                            <div id="dashboard-difficulty-chart"></div>
                        </div>
                    </div>
                    <div id="dashboard-key-takeaways"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-6 border-t">
                        <div id="dashboard-case-summary"></div>
                        <div id="dashboard-calendar-tracker"></div>
                    </div>
                </main>
            </div>
        </div>

        <!-- PROFILE VIEW (NEW) -->
        <div id="profile-view" class="hidden">
            <!-- Content Injected by JS -->
        </div>

    </main>

    <!-- COMPANY SELECTION MODAL -->
    <div id="company-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all flex flex-col h-[80vh]">
            <div class="p-6 border-b"><h2 class="text-2xl font-bold gradient-text">Select Companies</h2></div>
            <div id="company-list" class="p-6 overflow-y-auto flex-grow grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            <div class="p-4 bg-slate-50 border-t flex justify-between items-center">
                 <label class="flex items-center space-x-2 font-semibold">
                     <input type="checkbox" id="all-companies-checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                     <span>Select All</span>
                 </label>
                <div>
                    <button id="clear-companies-btn" class="px-6 py-2 rounded-lg font-semibold hover:bg-slate-200 transition mr-2">Clear</button>
                    <button id="apply-companies-btn" class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Apply</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- WARNING MODAL -->
    <div id="warning-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md transform transition-all text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">Heads Up!</h2>
            <p class="text-slate-600 mb-6">You are about to enter the interviewer's view, which contains the full case solution. Proceed only if you are the designated interviewer.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-warning-btn" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-semibold hover:bg-slate-300 transition">Cancel</button>
                <button id="proceed-btn" class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Proceed to Interview</button>
            </div>
        </div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg transform transition-all" id="feedback-modal-content">
            <h2 class="text-2xl font-bold mb-6 gradient-text">Case Feedback</h2>
            <div id="rating-parameters" class="space-y-4">
                 <div class="flex justify-between items-center">
                    <label class="text-slate-700 font-semibold">Structure</label>
                    <div class="star-rating" data-parameter="structure" data-weight="0.35">
                        <input type="radio" id="structure-star5" name="structure-rating" value="5" /><label for="structure-star5">&#9733;</label>
                        <input type="radio" id="structure-star4" name="structure-rating" value="4" /><label for="structure-star4">&#9733;</label>
                        <input type="radio" id="structure-star3" name="structure-rating" value="3" /><label for="structure-star3">&#9733;</label>
                        <input type="radio" id="structure-star2" name="structure-rating" value="2" /><label for="structure-star2">&#9733;</label>
                        <input type="radio" id="structure-star1" name="structure-rating" value="1" /><label for="structure-star1">&#9733;</label>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-slate-700 font-semibold">Case Understanding</label>
                    <div class="star-rating" data-parameter="understanding" data-weight="0.25">
                        <input type="radio" id="understanding-star5" name="understanding-rating" value="5" /><label for="understanding-star5">&#9733;</label>
                        <input type="radio" id="understanding-star4" name="understanding-rating" value="4" /><label for="understanding-star4">&#9733;</label>
                        <input type="radio" id="understanding-star3" name="understanding-rating" value="3" /><label for="understanding-star3">&#9733;</label>
                        <input type="radio" id="understanding-star2" name="understanding-rating" value="2" /><label for="understanding-star2">&#9733;</label>
                        <input type="radio" id="understanding-star1" name="understanding-rating" value="1" /><label for="understanding-star1">&#9733;</label>
                    </div>
                </div>
                 <div class="flex justify-between items-center">
                    <label class="text-slate-700 font-semibold">Delivery</label>
                    <div class="star-rating" data-parameter="delivery" data-weight="0.25">
                        <input type="radio" id="delivery-star5" name="delivery-rating" value="5" /><label for="delivery-star5">&#9733;</label>
                        <input type="radio" id="delivery-star4" name="delivery-rating" value="4" /><label for="delivery-star4">&#9733;</label>
                        <input type="radio" id="delivery-star3" name="delivery-rating" value="3" /><label for="delivery-star3">&#9733;</label>
                        <input type="radio" id="delivery-star2" name="delivery-rating" value="2" /><label for="delivery-star2">&#9733;</label>
                        <input type="radio" id="delivery-star1" name="delivery-rating" value="1" /><label for="delivery-star1">&#9733;</label>
                    </div>
                </div>
                 <div class="flex justify-between items-center">
                    <label class="text-slate-700 font-semibold">Creativity</label>
                    <div class="star-rating" data-parameter="creativity" data-weight="0.15">
                        <input type="radio" id="creativity-star5" name="creativity-rating" value="5" /><label for="creativity-star5">&#9733;</label>
                        <input type="radio" id="creativity-star4" name="creativity-rating" value="4" /><label for="creativity-star4">&#9733;</label>
                        <input type="radio" id="creativity-star3" name="creativity-rating" value="3" /><label for="creativity-star3">&#9733;</label>
                        <input type="radio" id="creativity-star2" name="creativity-rating" value="2" /><label for="creativity-star2">&#9733;</label>
                        <input type="radio" id="creativity-star1" name="creativity-rating" value="1" /><label for="creativity-star1">&#9733;</label>
                    </div>
                </div>
            </div>
            <hr class="my-6">
            <div class="text-center">
                <div class="flex justify-center items-center gap-2">
                    <p class="text-slate-700 font-semibold">Overall Rating</p>
                    <div class="group relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        <div class="absolute bottom-full z-10 mb-2 w-64 bg-slate-800 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                            Weighted average: Structure (35%), Case Understanding (25%), Delivery (25%), Creativity (15%).
                            <svg class="absolute text-slate-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                        </div>
                    </div>
                </div>
                <div id="overall-rating-display" class="flex justify-center mt-1"></div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="save-feedback-btn" class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Save & Track</button>
            </div>
        </div>
    </div>

    <!-- INSIGHT MODAL (FOR VIEWING AI FEEDBACK) -->
    <div id="insight-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto transform transition-all p-6 relative">
            <button onclick="document.getElementById('insight-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="ph ph-x text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph ph-sparkle text-purple-500"></i> AI Insights</h2>
            <div id="insight-content" class="prose prose-slate ai-content text-sm"></div>
        </div>
    </div>

    <!-- LOGIN / PROFILE CREATION MODAL -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-extrabold gradient-text">Create Your Profile</h2>
                    <p class="text-slate-500 mt-2">Sign up to track your progress.</p>
                </div>
                <form id="login-form" class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-3 text-center">Choose Your Archetype</label>
                        <div class="flex justify-center gap-4" id="mascot-selection-container"></div>
                        <input type="hidden" id="selected-mascot-id" required>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Full Name</label>
                            <input type="text" id="user-fullname-input" required placeholder="John Doe" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Username</label>
                                <input type="text" id="user-name-input" required placeholder="StratMaster" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">College/Uni</label>
                                <input type="text" id="user-college-input" placeholder="SRCC" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Email Address</label>
                            <input type="email" id="user-email-input" required placeholder="john@example.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                        </div>
                    </div>
                    <div class="pt-4 flex items-center justify-between">
                        <button type="button" id="skip-login-btn" class="text-slate-400 font-medium text-sm hover:text-slate-600">Skip for now</button>
                        <button type="submit" class="gradient-bg text-white px-8 py-2.5 rounded-lg font-bold shadow-md hover:opacity-90 transform transition hover:-translate-y-0.5">Login / Sign Up</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CALENDAR DAY DETAIL MODAL -->
    <div id="calendar-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 dashboard-animate-fade-in">
        <div id="calendar-modal-content" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"></div>
    </div>

    <!-- Main Module Script -->
    <script type="module">
        // --- Direct PDF.js Import ---
        import * as pdfjsLib from 'https://mozilla.github.io/pdf.js/build/pdf.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.mjs';

        // --- Gemini API Key ---
        const GEMINI_API_KEY = "AIzaSyAF1vxepCPUaHCC1CDe9uY3ypKt7polR_E";

        // --- Data ---
        const allCases = [
            { id: 1, title: 'Accelerating Prosperity', type: 'Growth', difficulty: 'Easy', company: 'Kepler Cannon', problem: 'How would you, as a consultant, for PM Modi, advise him to grow the GDP of India faster than any other country and generate lots of jobs in the process? The aim is prosperity and has to be done by our recommendation only.'},
            { id: 2, title: 'An Apple a Day', type: 'Unconventional', difficulty: 'Easy', company: 'Accenture Strategy', problem: "You're a part of Apple's strategy team. Apple is considering to start renting out earphones on an early basis, should they go ahead with it or not?"},
            { id: 3, title: 'Brewing Success', type: 'Market Entry', difficulty: 'Moderate', company: 'Accenture Strategy', problem: 'You have to open a coffee shop in Delhi. What are the factors you would consider?'},
            { id: 4, title: 'Bucks over Brands', type: 'Market Entry', difficulty: 'Moderate', company: 'LEK Capability Network', problem: 'Your Company has 2 online retail shops, one is a premium retail shop and the other one is a cheap retail shop. Both are very similar in nature, so figure out the possible reasons as to why the cheaper retail store has a higher profit margin than the premium shop.'},
            { id: 5, title: 'Building the Bank', type: 'Profitability', difficulty: 'High', company: 'McKinsey & Co.', problem: 'The client in a Banking Client from a large private sector firm - like Axis Bank- in India. The company wants to start a 3-in-1 account: a savings account + DMAT account + Trading account. The company already has a customer base of 5 million people. How would you determine how many people are interested to sign up for this?'},
            { id: 6, title: 'Can Taylor Swift come to India?', type: 'Profitability', difficulty: 'High', company: 'McKinsey & Co.', problem: 'You are Taylor Swift’s Brand Manager. Do you think Taylor swift should enter the Indian Market? Give a complete financial analysis with relevant justifications.'},
            { id: 7, title: 'Can the ants cross each other?', type: 'Unconventional', difficulty: 'Moderate', company: 'Bain Capability Network', problem: "There is an equilateral triangle and there is an ant present at each end. What is the probability that these ants don't cross each other?"},
            { id: 8, title: 'Candy Catastrophe', type: 'Profitability', difficulty: 'Moderate', company: 'Accenture Strategy', problem: 'Your client is an FMCG manufacturer comparable to Cadbury. The company has been facing a decline in profits. Help them figure out the exact reason for this decline.'},
            { id: 9, title: 'Cash Capsule', type: 'Profitability', difficulty: 'Moderate', company: 'McKinsey & Co.', problem: 'Your client is a pharmaceutical company in the USA. They have finished phase 3 trials of a pill. Its price is $2, and it treats a neurological disorder. You are required to calculate the revenue for the first year.'},
            { id: 10, title: 'Chic Expansion', type: 'Market Entry', difficulty: 'Moderate', company: 'BOD Consulting', problem: 'You are based in London, UK, and own a chain of fashion retailers. You feel that you have saturated your market in the UK. The company wants you to identify the factors to be considered in this entire decision-making process.'},
            { id: 11, title: 'Childhood Shield', type: 'Unconventional', difficulty: 'High', company: 'McKinsey & Co.', problem: 'A disease is spreading in South Africa that primarily affects children, and it can be contained through vaccination. However, a substantial portion of the population has not received vaccination. How would you approach this problem?'},
            { id: 12, title: 'Coffee Madness', type: 'Market Entry', difficulty: 'Easy', company: 'Accenture Strategy', problem: 'A coffee shop wants to enter the Delhi University Market. Should it? Why or why not?'},
            { id: 13, title: 'Cracking the Tile', type: 'Profitability', difficulty: 'Moderate', company: 'Boston Consulting Group', problem: "Your client is a tile manufacturing company, operating in the whole of India. They're facing a fall in their profits, in West and South Delhi. They're not facing this decline in the northern part. A 2-3% fall in the market share and a 15-18% fall in profits. Within India, we're ranked 5th as the tile manufacturing company. Awareness is the same in north and south, while consideration is one third. What according to you are the potential reasons?"},
            { id: 14, title: 'Data Insight', type: 'Unconventional', difficulty: 'High', company: 'McKinsey & Co.', problem: 'Devise ways to leverage the data Like customer names, the number of watches purchased, and their addresses for understanding consumer behaviour, and preferences, and potentially improving business strategies for the watch shop.'},
            { id: 15, title: "Don't Sugarcoat it!", type: 'Profitability', difficulty: 'Easy', company: 'Nation with Namo', problem: 'Your client is a sugarcane factory in India. The company is facing stagnant profits. You need to find the reasons for the problem.'},
            { id: 16, title: 'Droned Crops!', type: 'Market Entry', difficulty: 'Moderate', company: 'McKinsey & Co.', problem: 'Estimate the Market size of agricultural spray drones?'},
            { id: 17, title: 'Dynamic Democracy', type: 'Unconventional', difficulty: 'Easy', company: 'Nation With Namo', problem: 'Your client is a local successful businessman who is active socially with NGOs. He wants to stand as an independent candidate in the Shakarupur constituency. Advise the client on this political endeavor.'},
            { id: 18, title: 'Efficient Transit', type: 'Unconventional', difficulty: 'High', company: 'Kearney', problem: 'Our Client is the Ministry of Transport and they want to improve the logistical efficiency.'},
            { id: 19, title: 'Expansion Endeavours', type: 'Growth', difficulty: 'Moderate', company: 'Boston Consulting Group', problem: 'Your Client is a Non banking financial company and functions as a public sector undertaking. Suggest a suitable growth strategy.'},
            { id: 20, title: 'Fitness Finances', type: 'Market Entry', difficulty: 'Moderate', company: 'LEK Capability Network', problem: 'Your client is a health tech startup that manufactures special wearable devices like smartwatches or shoulder pads which measure the fitness of an individual. The company caters to the age group of 25-45 years. The price of one watch is $150. Calculate the annual revenue in the target market having 40 health-tech startups and the profit per unit.'},
            { id: 21, title: 'Get your Pulse on It', type: 'Market Entry', difficulty: 'Moderate', company: 'Bain Capability Network', problem: 'The manufacturer of a health-tech device is planning to launch the product in the US market. This is their very first product launch. Estimate their market size.'},
            { id: 22, title: 'Good and Excellent', type: 'Profitability', difficulty: 'Moderate', company: 'LEK Capability Network', problem: 'There are two drink companies. One is named Good. Another is Excellent. They both have a steady revenue growth for the past five years and the market size of both these are the same. The Good profits have been steady but Excellent profits are fluctuating. Find reason for the fluctuating profits of Excellent company.'},
            { id: 23, title: 'Growth Beyond Borders', type: 'Market Entry', difficulty: 'High', company: 'LEK Capability Network', problem: 'Your client is a fast fashion retail chain called My Brands. They have a considerable market share in the US economy but are now facing market saturation. They want to expand to new geographies but aren’t sure where to expand. Your task is to first list down the different factors to evaluate a potential geography to which they can extend their operations and state what strategies you would use to enter that particular country or geography.'},
            { id: 24, title: 'Home Haven Expansion', type: 'Growth', difficulty: 'Moderate', company: 'Redseer Consulting', problem: 'Our Client Amazon India is growing in the home furnishing industry and they want to grow faster.'},
            { id: 25, title: 'Hotel Shotel', type: 'Market Entry', difficulty: 'High', company: 'Kearney', problem: 'Your client is a large hotel chain that wishes to enter the Indian market. How would you advise them to go about it?'},
            { id: 26, title: 'Ink In or Ink Out?', type: 'Market Entry', difficulty: 'High', company: 'Accenture Strategy', problem: 'Your client is a paper manufacturing company based out of Indonesia. They operate in the B2B space and sell paper to publishing houses. They are considering expanding operations by entering India. Ascertain if this is a good strategy.'},
            { id: 27, title: 'Learning the English Way', type: 'Unconventional', difficulty: 'High', company: 'Alvarez and Marsal', problem: 'Your client is Vedantu and Indian edtech giant seeking to enter three European countries. Give four parameters that you would consider with your rationale behind it.'},
            { id: 28, title: 'LifeEpic Launch', type: 'Market Entry', difficulty: 'Moderate', company: 'LEK Capability Network', problem: 'Your client is a major magazine publisher based in the US. It is considering the idea of launching a new lifestyle magazine. Analyse and recommend if he should go ahead with this idea.'},
            { id: 29, title: 'Lights, Camera, Fashion!', type: 'Market Entry', difficulty: 'High', company: 'LEK Capability Network', problem: 'Your client is a fashion retail brand called Watson. They are based in the US and are looking to expand because the US market has matured. Identify which market they should enter and create a framework to devise a checklist for evaluating countries to streamline entry decisions.'},
            { id: 30, title: 'Logistics Boost', type: 'Unconventional', difficulty: 'High', company: 'Kearney', problem: 'Our Client is the Ministry of Transport and they want to improve the logistical efficiency. You can talk about an approach to calculate the demand for roads at any point in time.'},
            { id: 31, title: 'Lubricant Lament', type: 'Growth', difficulty: 'Moderate', company: 'Boston Consulting Group', problem: 'Your Client is a lubricant player for 10 years in the Indian Market. They are ranked 3rd globally, and 8th in India. However, they are struggling with their Indian Market Presence. They want an aggressive market growth strategy where they want to increase their market growth by 5 times in the coming 1-2 years.'},
            { id: 32, title: 'Lux Cabs but Lax Revenues', type: 'Profitability', difficulty: 'Moderate', company: 'LEK Capability Network', problem: 'There are two cab aggregators- Quickride and Lux Cabs. The revenue of the former is stable. However, that of the latter is fluctuating. You are the CEO and the other board members are quite agitated because of this. What solutions would you propose?'},
            { id: 33, title: 'Mad Amount of Angles', type: 'Profitability', difficulty: 'Easy', company: 'Boston Consulting Group', problem: "Your client is a potato snacks company in the Middle East. They're facing a gradual decline in their profits over the last five to six years. It was a gradual decline. Find out why."},
            { id: 34, title: 'Meat Me at our Spot', type: 'Unconventional', difficulty: 'Easy', company: 'Boston Consulting Group', problem: 'Your client is mock-meat manufacturer. Come at a particular income class of people who actually buy this product?'},
            { id: 35, title: 'Metals to Multiverse', type: 'Market Entry', difficulty: 'High', company: 'Kepler Cannon', problem: 'Your client is running a Mining and Metals Company. Now, they want to enter different industries. How would you go about evaluating its options?'},
            { id: 36, title: 'Not a Coin Toss', type: 'Unconventional', difficulty: 'Moderate', company: 'Nation with Namo', problem: 'There is an election and two candidates are being considered for it. Compare two candidates for the same.'},
            { id: 37, title: 'Party at the Polls', type: 'Unconventional', difficulty: 'Moderate', company: 'Nation With Namo', problem: 'Develop a strategy to engage young, first-time voters in your area and encourage them to vote for your party.'},
            { id: 38, title: 'Pigment Prospects', type: 'Market Entry', difficulty: 'Moderate', company: 'McKinsey & Co.', problem: 'The client specializes in producing pigments used in household paints and cosmetics. As a family-run business, they are looking to invest and are deciding between the house paint and makeup segments. Their main objective is to improve their business and secure its future. Evaluate segments where they can diversify.'},
            { id: 39, title: 'Pipes to Progress', type: 'Growth', difficulty: 'High', company: 'Kearney', problem: "Our client is an iron pipe manufacturing company. Their revenues have been stagnant, and they're seeking ways to increase growth. What approach would you suggest?"},
            { id: 40, title: 'Potato Potahto', type: 'Profitability', difficulty: 'Easy', company: 'Bain Capability Network', problem: "Your client is a potato snacks company in the Middle East. They're facing a gradual decline in their profits over the last five to six years. And you need to find out why. Additionally, it was a gradual decline."},
            { id: 41, title: 'Profit Puzzle', type: 'Profitability', difficulty: 'High', company: 'LEK Capability Network', problem: 'In the US market, there are two online retailers, Budget Mart and Elite Goods. Budget Mart provides budget-friendly goods to consumers, and Elite Goods caters to only the high-income groups, providing premium products at high prices. The revenue of Budget Mart is $100 million, and for Elite Goods, it is $120 million dollars. However, the profit margin of Budget Mart is greater than the profit of Elite Goods. Your client is Elite Goods, and it wants you to identify why Budget Mart has greater profits even after catering to the lower-income category. As a consultant, you are required to pinpoint those key areas due to which Elite Goods might be facing the problem.'},
            { id: 42, title: 'Profit Revive', type: 'Profitability', difficulty: 'Moderate', company: 'Accenture Strategy', problem: 'Your client is an owner of a toy store situated in a fairly busy area. The business is doing good. Revenues have increased and the cost has also not shown any alarming fluctuation. However, the profitability of the business is going down. Find out the reason and suggest remedies.'},
            { id: 43, title: 'Reading Revenues', type: 'Profitability', difficulty: 'High', company: 'Nation With Namo', problem: 'You are the Marketing Manager of your favourite author. Your task is to double the sales of your favourite book by this author. How would you do this?'},
            { id: 44, title: 'Retail Landscape Analysis', type: 'Market Entry', difficulty: 'High', company: 'Kearney', problem: 'Our Client is a high-end retail chain based in India. Estimate the market size and the number of supermarket stores that we could get for the client.'},
            { id: 45, title: 'Ride on Hotel California', type: 'Market Entry', difficulty: 'Moderate', company: 'Alvarez and Marsal', problem: 'A hotel wants to install an amusement park in the premises. What is your take on the same ?'},
            { id: 46, title: 'Sky High Harvest', type: 'Profitability', difficulty: 'Easy', company: 'Boston Consulting Group', problem: 'Your client is a tractor manufacturer. They have been facing a decline in sales for the past one year. You need to find out the reason for the decline.'},
            { id: 47, title: 'Sole Mates', type: 'Market Entry', difficulty: 'Easy', company: 'LEK Capability Network', problem: 'Your client is a sneaker manufacturer in the footwear industry and they are trying to expand into other sectors. Decode the factors that must be considered by the company to expand into a new sector. What products do you think they can enter into?'},
            { id: 48, title: 'Statistically Speaking', type: 'Unconventional', difficulty: 'Easy', company: 'Bain Capability Network', problem: 'You are running an election for the President of the Statistics Department. How do you run a successful campaign?'},
            { id: 49, title: 'The Dotcom Crisis', type: 'Market Entry', difficulty: 'Moderate', company: 'Indus Insights', problem: 'Your client is an e-commerce company. It’s looking to enter the US market. For their entry, they’re looking to market themselves through two different methods of SEO- banner ads and URL ads. Which type of ads should the company proceed with?'},
            { id: 50, title: 'The Fast & The Furious', type: 'Unconventional', difficulty: 'Moderate', company: 'Bain & Co.', problem: 'Your client has found a new method to transport people from India to the USA in just 30 minutes. Decide how to price this service.'},
            { id: 51, title: 'The Social Dilemma', type: 'Unconventional', difficulty: 'Moderate', company: 'Boston Consulting Group', problem: 'Your driver gets 20,000 rs. a month. He heard from somewhere that he can make more money if he joins Uber. Elaborate on what you think would be the right decision for him.'},
            { id: 52, title: 'Time in a Bottle', type: 'Market Entry', difficulty: 'Moderate', company: 'LEK Capability Network', problem: 'There is a healthcare company in the United States that makes products for various diseases, and now the company is planning to enter the smartwatch sector. What are the factors that you would consider?'},
            { id: 53, title: 'TimeWarp Travel', type: 'Pricing', difficulty: 'Moderate', company: 'Kearney', problem: 'Your client is an Airplane service provider. A new service has been introduced that enables you to travel from New Delhi to New York in just one hour, and they are promoting their brand based on the time-saving aspect of this service. How would you price this service?'},
            { id: 54, title: 'TRUCKload of Gasoline', type: 'Profitability', difficulty: 'Easy', company: 'LEK Capability Network', problem: 'Your client is a trucking company deciding between adopting an electric fleet or a gasoline fleet. As a consultant, determine the optimal choice.'},
            { id: 55, title: 'Unwaivering Allegiance', type: 'Unconventional', difficulty: 'Easy', company: 'Bain & Co.', problem: 'An e-commerce brand is trying to launch a loyalty programme, you are required to delve into the expected costs of the programme.'},
            { id: 56, title: 'Where are the Kids?', type: 'Unconventional', difficulty: 'Easy', company: 'Nation with Namo', problem: 'Elections often face apathy from certain sections of society like women, the elderly etc. How would you increase youth participation in election?'}
        ];
        const casebooks = {
            1: 'cases/Accelerating Prosperity II Growth II Easy II Kepler Cannon.pdf',
            2: 'cases/An Apple a Day II Unconventional II Easy II Accenture Strategy.pdf',
            3: 'cases/Brewing Success II Market Entry II Moderate II Accenture Strategy.pdf',
            4: 'cases/Bucks over Brands II Market Entry II Moderate II LEK Capability Network.pdf',
            5: 'cases/Building the Bank II Profitability II High II McKinsey & Co..pdf',
            6: 'cases/Can Taylor Swift come to India II Profitability II High II McKinsey & Co..pdf',
            7: 'cases/Can the ants cross each other II Unconventional II Moderate II Bain Capability Network.pdf',
            8: 'cases/Candy Catastrophe II Profitability II Moderate II Accenture Strategy.pdf',
            9: 'cases/Cash Capsule II Profitability II Moderate II McKinsey & Co..pdf',
            10: 'cases/Chic Expansion II Market Entry II Moderate II BOD Consulting.pdf',
            11: 'cases/Childhood Shield II Unconventional II High II McKinsey & Co..pdf',
            12: 'cases/Coffee Madness II Market Entry II Easy II Accenture Strategy.pdf',
            13: 'cases/Cracking the Tile II Profitability II Moderate II Boston Consulting Group.pdf',
            14: 'cases/Data Insight II Unconventional II High II McKinsey & Co..pdf',
            15: "cases/Don't Sugarcoat it! II Profitability II Easy II Nation with Namo.pdf",
            16: 'cases/Droned Crops! II Market Entry II Moderate II McKinsey & Co..pdf',
            17: 'cases/Dynamic Democracy II Unconventional II Easy II Nation With Namo.pdf',
            18: 'cases/Efficient Transit II Unconventional II High II Kearney.pdf',
            19: 'cases/Expansion Endeavours II Growth II Moderate II Boston Consulting Group.pdf',
            20: 'cases/Fitness Finances II Market Entry II Moderate II LEK Capability Network.pdf',
            21: 'cases/Get your Pulse on It II Market Entry II Moderate II Bain Capability Network.pdf',
            22: 'cases/Good and Excellent II Profitability II Moderate II LEK Capability Network.pdf',
            23: 'cases/Growth Beyond Borders II Market Entry II High II LEK Capability Network.pdf',
            24: 'cases/Home Haven Expansion II Growth II Moderate II Redseer Consulting.pdf',
            25: 'cases/Hotel Shotel II Market Entry II High II Kearney.pdf',
            26: 'cases/Ink In or Ink Out II Market Entry II High II Accenture Strategy.pdf',
            27: 'cases/Learning the English Way II Unconventional II High II Alvarez and Marsal.pdf',
            28: 'cases/LifeEpic Launch II Market Entry II Moderate II LEK Capability Network.pdf',
            29: 'cases/Lights, Camera, Fashion! II Market Entry II High II LEK Capability Network.pdf',
            30: 'cases/Logistics Boost II Unconventional II High II Kearney.pdf',
            31: 'cases/Lubricant Lament II Growth II Moderate II Boston Consulting Group.pdf',
            32: 'cases/Lux Cabs but Lax Revenues II Profitability II Moderate II LEK Capability Network.pdf',
            33: 'cases/Mad Amount of Angles II Profitability II Easy II Boston Consulting Group.pdf',
            34: 'cases/Meat Me at our Spot II Unconventional II Easy II Boston Consulting Group.pdf',
            35: 'cases/Metals to Multiverse II Market Entry II High II Kepler Cannon.pdf',
            36: 'cases/Not a Coin Toss II Unconventional II Moderate II Nation with Namo.pdf',
            37: 'cases/Party at the Polls II Unconventional II Moderate II Nation With Namo.pdf',
            38: 'cases/Pigment Prospects II Market Entry II Moderate II McKinsey & Co..pdf',
            39: 'cases/Pipes to Progress II Growth II High II Kearney.pdf',
            40: 'cases/Potato Potahto II Profitability II Easy II Bain Capability Network.pdf',
            41: 'cases/Profit Puzzle II Profitability II High II LEK Capability Network.pdf',
            42: 'cases/Profit Revive II Profitability II Moderate II Accenture Strategy.pdf',
            43: 'cases/Reading Revenues II Profitability II High II Nation With Namo.pdf',
            44: 'cases/Retail Landscape Analysis II Market Entry II High II Kearney.pdf',
            45: 'cases/Ride on Hotel California II Market Entry II Moderate II Alvarez and Marsal.pdf',
            46: 'cases/Sky High Harvest II Profitability II Easy II Boston Consulting Group.pdf',
            47: 'cases/Sole Mates II Market Entry II Easy II LEK Capability Network.pdf',
            48: 'cases/Statistically Speaking II Unconventional II Easy II Bain Capability Network.pdf',
            49: 'cases/The Dotcom Crisis II Market Entry II Moderate II Indus Insights.pdf',
            50: 'cases/The Fast & The Furious II Unconventional II Moderate II Bain & Co..pdf',
            51: 'cases/The Social Dilemma II Unconventional II Moderate II Boston Consulting Group.pdf',
            52: 'cases/Time in a Bottle II Market Entry II Moderate II LEK Capability Network.pdf',
            53: 'cases/TimeWarp Travel II Pricing II Moderate II Kearney.pdf',
            54: 'cases/TRUCKload of Gasoline II Profitability II Easy II LEK Capability Network.pdf',
            55: 'cases/Unwaivering Allegiance II Unconventional II Easy II Bain & Co..pdf',
            56: 'cases/Where are the Kids II Unconventional II Easy II Nation with Namo.pdf',
            default: 'cases/Accelerating Prosperity II Growth II Easy II Kepler Cannon.pdf'
        };

        // --- State Management ---
        let currentCase = null;
        let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null;
        let currentRenderTask = null;
        let selectedTypes = [];
        let selectedDifficulties = [];
        let selectedCompanies = [];
        
        // User State
        let userProfile = JSON.parse(localStorage.getItem('caseBuddyUser')) || null;
        if(userProfile && !userProfile.history) {
            userProfile.history = [];
            userProfile.stats = { solved: 0, streak: 1, lastActive: new Date().toISOString() };
            localStorage.setItem('caseBuddyUser', JSON.stringify(userProfile));
        }

        // --- DOM Elements ---
        const welcomeView = document.getElementById('welcome-view');
        const caseLibraryView = document.getElementById('case-library-view');
        const detailedCaseView = document.getElementById('detailed-case-view');
        const inProgressView = document.getElementById('in-progress-view');
        const aboutView = document.getElementById('about-view');
        const dashboardView = document.getElementById('dashboard-view');
        const profileView = document.getElementById('profile-view');
        
        const caseGrid = document.getElementById('case-grid');
        const homeButton = document.getElementById('home-button');
        const navActionsContainer = document.getElementById('nav-actions-container');
        
        // Filter elements
        const typeFiltersContainer = document.getElementById('type-filters');
        const difficultyFiltersContainer = document.getElementById('difficulty-filters');
        const openCompanyModalBtn = document.getElementById('open-company-modal-btn');
        const companyCountEl = document.getElementById('company-count');
        const searchCasesBtn = document.getElementById('search-cases-btn');
        const viewAllBtn = document.getElementById('view-all-btn');
        const backToFiltersBtn = document.getElementById('back-to-filters-btn');

        // Detailed View Elements
        const backToLibraryBtn = document.getElementById('back-to-library-btn');
        const doCaseBtn = document.getElementById('do-case-btn');

        // In-Progress View Elements
        const endCaseBtn = document.getElementById('end-case-btn');
        const pdfCanvas = document.getElementById('pdf-canvas'),
              pdfRenderContainer = document.getElementById('pdf-render-container'),
              pageNumEl = document.getElementById('page-num'),
              pageCountEl = document.getElementById('page-count'),
              prevPageBtn = document.getElementById('pdf-prev'),
              nextPageBtn = document.getElementById('pdf-next'),
              fullscreenBtn = document.getElementById('pdf-fullscreen');
        
        // Voice & AI Elements
        const recordBtn = document.getElementById('record-btn');
        const transcriptBox = document.getElementById('transcript-box');
        const statusText = document.getElementById('status-text');
        const analyzeBtn = document.getElementById('analyze-btn');
        const aiContainer = document.getElementById('ai-result-container');
        const aiOutput = document.getElementById('ai-output');
        const btnText = document.getElementById('btn-text');
        const clearBtn = document.getElementById('clear-btn');

        // Modals
        const companyModal = document.getElementById('company-modal');
        const warningModal = document.getElementById('warning-modal');
        const feedbackModal = document.getElementById('feedback-modal');
        const loginModal = document.getElementById('login-modal');
        const insightModal = document.getElementById('insight-modal');
        const insightContent = document.getElementById('insight-content');
        
        const companyListContainer = document.getElementById('company-list');
        const allCompaniesCheckbox = document.getElementById('all-companies-checkbox');
        const clearCompaniesBtn = document.getElementById('clear-companies-btn');
        const applyCompaniesBtn = document.getElementById('apply-companies-btn');
        const cancelWarningBtn = document.getElementById('cancel-warning-btn');
        const proceedBtn = document.getElementById('proceed-btn');
        
        // Feedback Modal Elements
        const ratingParameters = document.getElementById('rating-parameters');
        const overallRatingDisplay = document.getElementById('overall-rating-display');
        const saveFeedbackBtn = document.getElementById('save-feedback-btn');

        // Login Modal Elements
        const loginForm = document.getElementById('login-form');
        const mascotContainer = document.getElementById('mascot-selection-container');
        const mascotInput = document.getElementById('selected-mascot-id');
        const skipLoginBtn = document.getElementById('skip-login-btn');

        // --- Gamification Data (Mascots) ---
        const commonAvatarSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-full h-full">
                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
            </svg>
        `;

        const mascots = [
            { id: 0, color: '#3b82f6', shadow: 'rgba(59, 130, 246, 0.25)' }, // Blue
            { id: 1, color: '#6366f1', shadow: 'rgba(99, 102, 241, 0.25)' }, // Indigo
            { id: 2, color: '#10b981', shadow: 'rgba(16, 185, 129, 0.25)' }, // Emerald
            { id: 3, color: '#f59e0b', shadow: 'rgba(245, 158, 11, 0.25)' }, // Amber
            { id: 4, color: '#64748b', shadow: 'rgba(100, 116, 139, 0.25)' }, // Slate
        ];

        // --- Speech Recognition Logic ---
        let recognition;
        let isRecording = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isRecording = true;
                recordBtn.classList.add('recording-active');
                recordBtn.innerHTML = '<i class="ph ph-stop text-xl font-bold"></i>';
                statusText.textContent = "Listening...";
                statusText.className = "text-xs text-red-500 font-bold animate-pulse";
                transcriptBox.placeholder = "Listening...";
            };

            recognition.onend = () => {
                isRecording = false;
                recordBtn.classList.remove('recording-active');
                recordBtn.innerHTML = '<i class="ph ph-microphone text-lg"></i>';
                statusText.textContent = "Recording stopped.";
                statusText.className = "text-xs text-slate-400";
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                if (finalTranscript) {
                    const currentText = transcriptBox.value;
                    const prefix = (currentText && !currentText.endsWith(' ')) ? ' ' : '';
                    transcriptBox.value = currentText + prefix + finalTranscript;
                    transcriptBox.scrollTop = transcriptBox.scrollHeight;
                    if(transcriptBox.value.length > 0) clearBtn.classList.remove('hidden');
                }
            };
        } else {
            transcriptBox.value = "Speech Recognition not supported in this browser.";
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // --- Gemini AI Logic ---
        async function callGeminiAPI(feedbackText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const prompt = `
                You are an expert case interview coach. Analyze this feedback transcript:
                "${feedbackText}"
                Output ONLY HTML. Structure exactly like this:
                <h3>✅ Key Strengths</h3>
                <ul><li>Point 1</li><li>Point 2</li></ul>
                <h3>🚀 Areas for Improvement</h3>
                <ul><li>Point 1</li><li>Point 2</li></ul>
                Keep it professional and actionable.
            `;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error('API Request Failed');
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // --- Main App Functions ---

        function showView(viewToShow) {
            [welcomeView, caseLibraryView, detailedCaseView, inProgressView, aboutView, dashboardView, profileView].forEach(view => {
                view.classList.add('hidden');
            });
            viewToShow.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function createCaseCard(caseData) {
            const card = document.createElement('div');
            card.className = 'case-card bg-white p-6 rounded-lg cursor-pointer flex flex-col';
            card.innerHTML = `
                <h3 class="font-bold text-xl mb-2 truncate">${caseData.title}</h3>
                <p class="text-slate-500 text-sm mb-4 h-10 overflow-hidden flex-grow">${caseData.problem}</p>
                <div class="flex items-center flex-wrap gap-2 text-sm text-slate-500 mt-4">
                    <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-medium">${caseData.type}</span>
                    <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full font-medium">${caseData.company}</span>
                    <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-medium">${caseData.difficulty}</span>
                </div>
            `;
            card.addEventListener('click', () => showDetailedCaseView(caseData.id));
            return card;
        }
        
        function renderLibraryView(casesToRender) {
            caseGrid.innerHTML = casesToRender.length === 0 ? `<p class="text-slate-500 col-span-full text-center text-lg">No cases match your criteria. Try broadening your search!</p>` : '';
            casesToRender.forEach(c => caseGrid.appendChild(createCaseCard(c)));
            showView(caseLibraryView);
        }
        
        function showDetailedCaseView(caseId) {
            const caseData = allCases.find(c => c.id === caseId);
            if (!caseData) return;
            currentCase = caseData;
            document.getElementById('case-detail-type').textContent = caseData.type;
            document.getElementById('case-detail-company').textContent = caseData.company;
            document.getElementById('case-detail-difficulty').textContent = caseData.difficulty;
            document.getElementById('case-detail-problem').textContent = caseData.problem;
            showView(detailedCaseView);
        }
        
        async function showInProgressView() {
            document.getElementById('casebook-title').textContent = `Interviewer's Guide: ${currentCase.title}`;
            const pdfPath = casebooks[currentCase.id] || casebooks.default;
            await initPdfViewer(pdfPath);
            // Reset Recorder UI
            transcriptBox.value = '';
            aiContainer.classList.add('hidden');
            aiOutput.innerHTML = '';
            showView(inProgressView);
        }

        // --- Filter Population and Handling ---

        function populateMultiSelectFilters(container, items, stateArray) {
            container.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn px-4 py-2 rounded-lg font-medium active';
            allBtn.textContent = 'All';
            allBtn.dataset.value = 'All';
            container.appendChild(allBtn);

            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn px-4 py-2 rounded-lg font-medium';
                btn.textContent = item;
                btn.dataset.value = item;
                container.appendChild(btn);
            });

            container.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') return;
                const value = e.target.dataset.value;
                const allButton = container.querySelector('[data-value="All"]');
                
                if (value === 'All') {
                    e.target.classList.add('active');
                    container.querySelectorAll('button:not([data-value="All"])').forEach(btn => btn.classList.remove('active'));
                    stateArray.length = 0;
                } else {
                    allButton.classList.remove('active');
                    e.target.classList.toggle('active');
                    const index = stateArray.indexOf(value);
                    if (index > -1) {
                        stateArray.splice(index, 1);
                    } else {
                        stateArray.push(value);
                    }
                    if (container.querySelectorAll('button.active:not([data-value="All"])').length === 0) {
                        allButton.classList.add('active');
                    }
                }
            });
        }
        
        function populateCompanyModal() {
            const companies = [...new Set(allCases.map(c => c.company))].sort();
            companyListContainer.innerHTML = '';
            companies.forEach(company => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-slate-700';
                label.innerHTML = `
                    <input type="checkbox" value="${company}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 company-checkbox">
                    <span>${company}</span>
                `;
                companyListContainer.appendChild(label);
            });
        }
        
        function handleSearch() {
            const filteredCases = allCases.filter(c => {
                const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(c.type);
                const difficultyMatch = selectedDifficulties.length === 0 || selectedDifficulties.includes(c.difficulty);
                const companyMatch = selectedCompanies.length === 0 || selectedCompanies.includes(c.company);
                return typeMatch && difficultyMatch && companyMatch;
            });
            renderLibraryView(filteredCases);
        }

        // --- PDF Viewer Functions ---
        async function initPdfViewer(url) {
            pageNum = 1;
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                pageCountEl.textContent = pdfDoc.numPages;
                renderPage(pageNum);
            } catch (error) {
                console.error('Error loading PDF:', error);
                pdfRenderContainer.innerHTML = `<p class="text-red-500 text-center">Error: Could not load PDF file. Please ensure the file '${url}' is in the correct folder.</p>`;
            }
        }

        function renderPage(num, isResize = false) {
            if (pageRendering) {
                if(currentRenderTask) currentRenderTask.cancel();
                pageNumPending = num;
                return;
            }
            pageRendering = true;

            if (!isResize) pdfCanvas.style.opacity = '0';

            pdfDoc.getPage(num).then(page => {
                const devicePixelRatio = window.devicePixelRatio || 1;
                const viewport1 = page.getViewport({ scale: 1 });
                const scale = pdfRenderContainer.clientWidth / viewport1.width;
                const viewport = page.getViewport({ scale: scale });
                const context = pdfCanvas.getContext('2d');
                
                pdfCanvas.style.width = `${viewport.width}px`;
                pdfCanvas.style.height = `${viewport.height}px`;
                pdfCanvas.width = Math.floor(viewport.width * devicePixelRatio);
                pdfCanvas.height = Math.floor(viewport.height * devicePixelRatio);
                context.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                currentRenderTask = page.render(renderContext);
                currentRenderTask.promise.then(() => {
                    pageRendering = false;
                    currentRenderTask = null;
                    if (!isResize) pdfCanvas.style.opacity = '1';
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
            pageNumEl.textContent = num;
            updateNavButtons();
        }

        function onPrevPage() { if (pageNum <= 1) return; pageNum--; renderPage(pageNum); }
        function onNextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; renderPage(pageNum); }

        function updateNavButtons() {
            prevPageBtn.disabled = (pageNum <= 1);
            nextPageBtn.disabled = (pageNum >= pdfDoc.numPages);
        }

        function toggleFullscreen() {
             if (!document.fullscreenElement) {
                pdfRenderContainer.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // --- Modal Logic ---
        function openCompanyModal() { companyModal.classList.remove('hidden'); companyModal.classList.add('flex'); }
        function closeCompanyModal() { companyModal.classList.remove('flex'); companyModal.classList.add('hidden'); }
        function openWarningModal() { warningModal.classList.remove('hidden'); warningModal.classList.add('flex');}
        function closeWarningModal() { warningModal.classList.remove('flex'); warningModal.classList.add('hidden');}
        function openFeedbackModal() { 
            resetFeedbackModal();
            feedbackModal.classList.remove('hidden'); 
            feedbackModal.classList.add('flex');
        }
        function closeFeedbackModal() { 
            feedbackModal.classList.remove('flex'); 
            feedbackModal.classList.add('hidden'); 
            showView(caseLibraryView); 
        }
        
        function applyCompanySelection() {
            selectedCompanies = Array.from(companyListContainer.querySelectorAll('.company-checkbox:checked')).map(cb => cb.value);
            if (selectedCompanies.length === 0) {
                companyCountEl.textContent = 'All companies selected';
            } else if (selectedCompanies.length === 1) {
                companyCountEl.textContent = '1 company selected';
            } else {
                companyCountEl.textContent = `${selectedCompanies.length} companies selected`;
            }
            closeCompanyModal();
        }

        // --- Feedback Logic & Analytics ---
        function calculateOverallRating() {
            let totalScore = 0;
            const ratingGroups = ratingParameters.querySelectorAll('.star-rating');
            const scores = {};

            ratingGroups.forEach(group => {
                const param = group.dataset.parameter;
                const weight = parseFloat(group.dataset.weight);
                const checkedRadio = group.querySelector('input[type="radio"]:checked');
                const value = checkedRadio ? parseInt(checkedRadio.value) : 0;
                scores[param] = value;
                totalScore += value * weight; // 5-point scale
            });
            
            const finalScore = Math.round((totalScore / 5) * 100);
            updateOverallRatingDisplay(totalScore);
            return { finalScore, scores };
        }

        function updateOverallRatingDisplay(score) {
            overallRatingDisplay.innerHTML = ''; 
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.classList.add('star');
                if (i <= Math.round(score)) {
                    star.classList.add('filled');
                }
                star.innerHTML = '&#9733;';
                overallRatingDisplay.appendChild(star);
            }
        }
        
        function resetFeedbackModal() {
            const allRadios = feedbackModal.querySelectorAll('input[type="radio"]');
            allRadios.forEach(radio => radio.checked = false);
            updateOverallRatingDisplay(0);
        }

        function saveFeedback() {
            if (!userProfile) {
                alert("Please create a profile to save your progress!");
                openLoginModal();
                return;
            }

            const { finalScore, scores } = calculateOverallRating();
            // Capture AI insights if generated
            const aiInsightText = aiOutput.innerHTML !== '' ? aiOutput.innerHTML : null;
            
            const record = {
                caseId: currentCase.id,
                name: currentCase.title,
                company: currentCase.company,
                type: currentCase.type,
                difficulty: currentCase.difficulty,
                date: new Date().toISOString().split('T')[0],
                structuring: scores.structure ? scores.structure * 6 : 0, 
                quantitative: scores.understanding ? scores.understanding * 3 : 0, 
                insight: scores.delivery ? scores.delivery * 7 : 0, 
                communication: scores.creativity ? scores.creativity * 4 : 0,
                totalScore: finalScore,
                aiInsights: aiInsightText // Saving the insight HTML
            };

            if (!userProfile.history) userProfile.history = [];
            userProfile.history.push(record);
            
            if (!userProfile.stats) userProfile.stats = { solved: 0, streak: 0, lastActive: null };
            userProfile.stats.solved++;
            
            const today = new Date().toDateString();
            const lastActive = userProfile.stats.lastActive ? new Date(userProfile.stats.lastActive).toDateString() : null;
            
            if (lastActive !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (lastActive === yesterday.toDateString()) {
                    userProfile.stats.streak++;
                } else {
                    userProfile.stats.streak = 1;
                }
                userProfile.stats.lastActive = new Date().toISOString();
            }

            localStorage.setItem('caseBuddyUser', JSON.stringify(userProfile));
            alert("Case tracked! Check your dashboard.");
            closeFeedbackModal();
            
            renderNav();
            initializeDashboard();
        }

        // --- User Profile / Login System ---
        function initLoginSystem() {
            renderNav();
            if (!userProfile && !sessionStorage.getItem('loginSkipped')) {
                setTimeout(openLoginModal, 1500);
            }
        }

        function renderNav() {
            navActionsContainer.innerHTML = ''; 

            if (userProfile) {
                const mascot = mascots[userProfile.mascotId] || mascots[0];
                
                const pillContainer = document.createElement('div');
                pillContainer.className = 'user-pill-container relative py-2';

                // Pill
                pillContainer.innerHTML = `
                    <div class="user-pill flex items-center gap-3 pl-1 pr-4 py-1.5 bg-white border border-slate-200 rounded-full cursor-pointer shadow-sm">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center p-1.5" 
                             style="background-color: ${mascot.color}15; color: ${mascot.color};">
                            ${commonAvatarSvg}
                        </div>
                        <div class="flex flex-col leading-none">
                            <span class="text-xs font-bold text-slate-700">${userProfile.username}</span>
                        </div>
                    </div>
                `;
                
                // Click to open profile
                pillContainer.addEventListener('click', renderUserProfile);
                navActionsContainer.appendChild(pillContainer);

                const dashboardBtn = document.createElement('button');
                dashboardBtn.textContent = 'Dashboard';
                dashboardBtn.className = 'text-slate-600 hover:text-blue-600 font-semibold transition-colors text-sm';
                dashboardBtn.addEventListener('click', () => showView(dashboardView));

                const aboutBtn = document.createElement('button');
                aboutBtn.textContent = 'About';
                aboutBtn.className = 'text-slate-600 hover:text-blue-600 font-semibold transition-colors text-sm';
                aboutBtn.addEventListener('click', () => showView(aboutView));

                navActionsContainer.appendChild(dashboardBtn);
                navActionsContainer.appendChild(aboutBtn);

            } else {
                const loginBtn = document.createElement('button');
                loginBtn.textContent = 'Login / Sign Up';
                loginBtn.className = 'text-sm font-bold text-white bg-slate-900 px-4 py-2 rounded-lg hover:bg-slate-800 transition';
                loginBtn.addEventListener('click', openLoginModal);

                const dashboardBtn = document.createElement('button');
                dashboardBtn.textContent = 'Dashboard';
                dashboardBtn.className = 'text-slate-600 hover:text-blue-600 font-semibold transition-colors text-sm';
                dashboardBtn.addEventListener('click', () => showView(dashboardView));

                const aboutBtn = document.createElement('button');
                aboutBtn.textContent = 'About';
                aboutBtn.className = 'text-slate-600 hover:text-blue-600 font-semibold transition-colors text-sm';
                aboutBtn.addEventListener('click', () => showView(aboutView));

                navActionsContainer.appendChild(loginBtn);
                navActionsContainer.appendChild(dashboardBtn);
                navActionsContainer.appendChild(aboutBtn);
            }
        }

        function renderUserProfile() {
            if(!userProfile) return;
            const mascot = mascots[userProfile.mascotId] || mascots[0];
            const stats = userProfile.stats || { solved: 0, streak: 0 };
            const history = userProfile.history || [];
            
            const avgScore = history.length > 0 
                ? Math.round(history.reduce((a, b) => a + b.totalScore, 0) / history.length) 
                : 0;

            profileView.innerHTML = `
                <div class="max-w-4xl mx-auto py-8 dashboard-animate-fade-in">
                    <!-- Header Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 mb-8 flex flex-col md:flex-row items-center gap-8">
                        <div class="w-32 h-32 rounded-full flex items-center justify-center p-6 shadow-inner" 
                             style="background-color: ${mascot.color}10; color: ${mascot.color};">
                            ${commonAvatarSvg}
                        </div>
                        <div class="text-center md:text-left flex-grow">
                            <h1 class="text-3xl font-extrabold text-slate-800 mb-1">${userProfile.name}</h1>
                            <p class="text-slate-500 font-medium text-sm mb-4">@${userProfile.username} • ${userProfile.college}</p>
                            <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600">
                                Member since ${new Date(userProfile.joinedDate).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="text-right">
                            <button onclick="logout()" class="text-red-500 hover:text-red-700 font-semibold text-sm border border-red-100 hover:bg-red-50 px-4 py-2 rounded-lg transition">Log Out</button>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div class="neo-card p-6 bg-neo-pink border-red-100">
                            <p class="text-xs font-bold uppercase opacity-70 mb-1">Cases Cracked</p>
                            <p class="text-4xl neo-stat-value">${stats.solved}</p>
                        </div>
                        <div class="neo-card p-6 bg-neo-cream border-yellow-100">
                            <p class="text-xs font-bold uppercase opacity-70 mb-1">Current Streak</p>
                            <p class="text-4xl neo-stat-value">${stats.streak} <span class="text-lg">days</span></p>
                        </div>
                        <div class="neo-card p-6 bg-neo-dark">
                            <p class="text-xs font-bold uppercase opacity-70 mb-1">Average Score</p>
                            <p class="text-4xl neo-stat-value text-green-400">${avgScore}</p>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <h3 class="text-xl font-bold text-slate-800 mb-4 px-2">Recent Activity</h3>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        ${history.length === 0 
                            ? `<div class="p-8 text-center text-slate-400">No cases solved yet. Go crack one!</div>`
                            : `<table class="w-full text-left">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><tr class="border-b"><th class="p-4">Date</th><th class="p-4">Case</th><th class="p-4">Score</th><th class="p-4 text-right">Action</th></tr></thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${history.slice().reverse().map((h, index) => `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="p-4 text-sm text-slate-500">${h.date}</td>
                                            <td class="p-4 font-medium text-slate-700">${h.name}</td>
                                            <td class="p-4 font-bold ${h.totalScore >= 85 ? 'text-green-600' : 'text-slate-600'}">${h.totalScore}</td>
                                            <td class="p-4 text-right">
                                                ${h.aiInsights 
                                                    ? `<button onclick="window.viewInsight(${history.length - 1 - index})" class="text-blue-600 text-xs font-bold hover:underline">View Insights</button>`
                                                    : `<span class="text-slate-300 text-xs">No Data</span>`
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                               </table>`
                        }
                    </div>
                </div>
            `;
            showView(profileView);
        }

        // Make viewInsight global for onclick access
        window.viewInsight = function(index) {
             const record = userProfile.history[index];
             if (record && record.aiInsights) {
                 insightContent.innerHTML = record.aiInsights;
                 insightModal.classList.remove('hidden');
                 insightModal.classList.add('flex');
             }
        };

        function openLoginModal() {
            mascotContainer.innerHTML = mascots.map((m) => `
                <div class="mascot-option w-16 h-16 rounded-full bg-white flex items-center justify-center cursor-pointer" 
                     style="--mascot-color: ${m.color}; --mascot-shadow: ${m.shadow}; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);"
                     data-id="${m.id}" onclick="selectMascot(this, ${m.id})">
                    <div style="width: 2.5rem; height: 2.5rem; color: ${m.color};">${commonAvatarSvg}</div>
                </div>
            `).join('');
            selectMascot(mascotContainer.children[0], 0);
            loginModal.classList.remove('hidden');
            loginModal.classList.add('flex');
        }

        window.selectMascot = function(el, id) {
            Array.from(mascotContainer.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            mascotInput.value = id;
        }

        function handleLoginSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('user-fullname-input').value;
            const username = document.getElementById('user-name-input').value;
            const email = document.getElementById('user-email-input').value;
            const college = document.getElementById('user-college-input').value;
            const mascotId = mascotInput.value;

            userProfile = {
                name, username, email, college, mascotId,
                joinedDate: new Date().toISOString(),
                history: [],
                stats: { solved: 0, streak: 1, lastActive: new Date().toISOString() }
            };

            localStorage.setItem('caseBuddyUser', JSON.stringify(userProfile));
            loginModal.classList.add('hidden');
            loginModal.classList.remove('flex');
            renderNav();
        }

        window.logout = function() {
            if(confirm("Are you sure you want to log out?")) {
                localStorage.removeItem('caseBuddyUser');
                userProfile = null;
                renderNav();
                showView(welcomeView);
            }
        }
        
        // --- Listeners ---
        loginForm.addEventListener('submit', handleLoginSubmit);
        skipLoginBtn.addEventListener('click', () => {
            sessionStorage.setItem('loginSkipped', 'true');
            loginModal.classList.add('hidden');
            loginModal.classList.remove('flex');
        });

        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });
        
        clearBtn.addEventListener('click', () => {
            transcriptBox.value = '';
            clearBtn.classList.add('hidden');
            aiContainer.classList.add('hidden');
            statusText.textContent = 'Cleared';
        });

        analyzeBtn.addEventListener('click', async () => {
            const text = transcriptBox.value.trim();
            if (text.length < 5) { 
                alert("Please record or type some feedback first.");
                return;
            }
            analyzeBtn.disabled = true;
            btnText.textContent = "Analyzing...";
            aiContainer.classList.add('hidden');
            try {
                const insights = await callGeminiAPI(text);
                aiOutput.innerHTML = insights.replace(/```html/g, '').replace(/```/g, '');
                aiContainer.classList.remove('hidden');
                aiContainer.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error(error);
                alert("Error calling AI. Please check console.");
            } finally {
                analyzeBtn.disabled = false;
                btnText.textContent = "Generate AI Insights";
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => { 
            const uniqueTypes = [...new Set(allCases.map(c => c.type))].sort();
            const uniqueDifficulties = [...new Set(allCases.map(c => c.difficulty))].sort();
            
            populateMultiSelectFilters(typeFiltersContainer, uniqueTypes, selectedTypes);
            populateMultiSelectFilters(difficultyFiltersContainer, uniqueDifficulties, selectedDifficulties);
            populateCompanyModal();
            
            showView(welcomeView);
            updateOverallRatingDisplay(0); 
            initializeDashboard();
            initLoginSystem();
        });

        // Navigation & Actions
        homeButton.addEventListener('click', () => showView(welcomeView));
        backToFiltersBtn.addEventListener('click', () => showView(welcomeView));
        backToLibraryBtn.addEventListener('click', () => showView(caseLibraryView));
        searchCasesBtn.addEventListener('click', handleSearch);
        viewAllBtn.addEventListener('click', () => renderLibraryView(allCases));
        doCaseBtn.addEventListener('click', openWarningModal);
        endCaseBtn.addEventListener('click', openFeedbackModal);
        
        prevPageBtn.addEventListener('click', onPrevPage);
        nextPageBtn.addEventListener('click', onNextPage);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        document.addEventListener('fullscreenchange', () => { if (pdfDoc) setTimeout(() => renderPage(pageNum, true), 100); });

        openCompanyModalBtn.addEventListener('click', openCompanyModal);
        applyCompaniesBtn.addEventListener('click', applyCompanySelection);
        companyModal.addEventListener('click', (e) => { if(e.target === companyModal) closeCompanyModal(); });
        allCompaniesCheckbox.addEventListener('change', (e) => { companyListContainer.querySelectorAll('.company-checkbox').forEach(cb => { cb.checked = e.target.checked; }); });
        clearCompaniesBtn.addEventListener('click', () => { companyListContainer.querySelectorAll('.company-checkbox').forEach(cb => { cb.checked = false; }); allCompaniesCheckbox.checked = false; });
        cancelWarningBtn.addEventListener('click', closeWarningModal);
        proceedBtn.addEventListener('click', () => { closeWarningModal(); showInProgressView(); });
        saveFeedbackBtn.addEventListener('click', saveFeedback);
        ratingParameters.addEventListener('change', calculateOverallRating);

        // --- Initial Dashboard Render ---
        renderDateRangePicker();
        renderDashboard();
    </script>
</body>
</html>
